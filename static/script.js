const box=document.getElementById("messages");const input=document.getElementById("text");const btn=document.getElementById("send");const statusText=document.getElementById("statusText");const chatList=document.getElementById("chatList");const newChatBtn=document.getElementById("newChat");
function linkify(text){const frag=document.createDocumentFragment();const url=/https?:\/\/\S+/g;const lines=String(text||"").split(/\r?\n/);for(let i=0;i<lines.length;i++){const line=lines[i];const span=document.createElement("span");let last=0;for(const m of line.matchAll(url)){const idx=m.index;const u=m[0];if(idx>last)span.appendChild(document.createTextNode(line.slice(last,idx)));const a=document.createElement("a");a.href=u;a.target="_blank";a.rel="noopener";a.textContent=u;span.appendChild(a);last=idx+u.length}if(last<line.length)span.appendChild(document.createTextNode(line.slice(last)));frag.appendChild(span);if(i<lines.length-1)frag.appendChild(document.createElement("br"))}return frag}
function add(text,cls){const d=document.createElement("div");d.className="msg "+cls;if(cls==="bot"){d.appendChild(linkify(text))}else{d.textContent=text}box.appendChild(d);box.scrollTop=box.scrollHeight}
async function send(){const m=(input.value||"").trim();if(!m)return;add("Você: "+m,"user");input.value="";btn.disabled=true;try{const r=await fetch("/responder",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mensagem:m})});if(!r.ok){const t=await r.text();add("Erro "+r.status+": "+t.slice(0,200),"bot");return}let j;try{j=await r.json()}catch{const t=await r.text();add("Erro ao ler resposta: "+t.slice(0,200),"bot");return}add("Less: "+(j.resposta||"Sem resposta"),"bot")}catch(e){add("Erro de conexão: "+(e&&e.message||e),"bot")}finally{btn.disabled=false}}
btn.addEventListener("click",send);input.addEventListener("keydown",e=>{if(e.key==="Enter")send()});
async function loadStatus(){try{const r=await fetch("/status");const j=await r.json();const ok=!!j.ready;statusText.textContent=`Status: ${ok?"OK":"Indisponível"} (${j.provider}/${j.model})`}catch{statusText.textContent="Status: indisponível"}}
loadStatus();
async function loadChats(){chatList.innerHTML="";try{const r=await fetch("/chat/list");const j=await r.json();(j.chats||[]).forEach(c=>{const div=document.createElement("div");div.className="chatitem";div.textContent=(c.title||"Nova conversa");div.onclick=()=>loadChat(c.id);chatList.appendChild(div)})}catch{}}
async function loadChat(id){box.innerHTML="";try{const r=await fetch(`/chat/load/${id}`);if(!r.ok){add("Erro ao carregar","bot");return}const j=await r.json();(j.messages||[]).forEach(m=>{add((m.role==="user"?"Você: ":"Less: ")+m.content,m.role==="user"?"user":"bot")})}catch{add("Erro ao carregar","bot")}}
async function newChat(){try{const r=await fetch("/chat/new",{method:"POST"});if(!r.ok)return;box.innerHTML="";await loadChats()}catch{}}
newChatBtn.addEventListener("click",newChat);loadChats();
const autoInd=document.getElementById("autoNewsInd");let lastNews=null;async function checkNews(){try{const topics=["general","tech","games"];const results=await Promise.all(topics.map(t=>fetch(`/news/latest?topic=${t}`).then(r=>r.ok?r.json():null).catch(()=>null)));const any=results.find(r=>r&&r.updated_at);const upd=any?any.updated_at:null;if(!upd||upd===lastNews)return;lastNews=upd;let txt="Novas notícias (geral/tech/games):\n";for(let i=0;i<topics.length;i++){const r=results[i];if(!r)continue;const items=(r.items||[]).slice(0,3);if(!items.length)continue;txt+=`\n${topics[i].toUpperCase()}:\n`;for(const it of items){txt+=`- ${it.title} – ${it.link}\n`}}txt=txt.trim();if(txt)add("Less: "+txt,"bot");if(autoInd)autoInd.textContent="Auto notícias: Atualizado"}catch{}}
setInterval(checkNews,20000);checkNews();
